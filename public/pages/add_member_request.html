<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>メンバー管理申請</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>メンバー管理申請</h1>
    <a href="/pages/top.html" class="back-link">← トップへ戻る</a>

    <section>
      <h2>申請モードを選択</h2>
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: var(--radius); cursor: pointer; background: var(--surface); transition: all 0.2s;">
          <input type="radio" name="requestMode" value="add" checked style="cursor: pointer;">
          <span>メンバー追加</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: var(--radius); cursor: pointer; background: var(--surface); transition: all 0.2s;">
          <input type="radio" name="requestMode" value="remove" style="cursor: pointer;">
          <span>メンバー削除</span>
        </label>
      </div>
      <p class="text-muted" id="modeDescription">グループにメンバーを追加する申請を行います。</p>
    </section>

    <section>
      <h2><span class="step-number">1</span>申請者を選択</h2>
      <div style="position: relative;">
        <input 
          type="text" 
          id="userSearchInput" 
          placeholder="ユーザー名、ID、メールアドレスで検索..."
          autocomplete="off"
          style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius); font-size: 1rem;"
        />
        <div id="userDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 2px solid var(--border-color); border-radius: var(--radius); margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow-lg);">
          <div id="userList" style="padding: 0.5rem;"></div>
        </div>
      </div>
      <input type="hidden" id="userSelect" value="" />
      <div id="selectedUser" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--background); border-radius: var(--radius); display: none;">
        <span style="font-weight: 600;">選択中: </span>
        <span id="selectedUserName"></span>
        <button type="button" id="clearUserBtn" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; background: var(--secondary-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.875rem;">クリア</button>
      </div>
    </section>

    <section>
      <h2><span class="step-number">2</span>対象グループを選択</h2>
      <div style="position: relative;">
        <input 
          type="text" 
          id="groupSearchInput" 
          placeholder="グループ名で検索..."
          autocomplete="off"
          disabled
          style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius); font-size: 1rem; opacity: 0.5;"
        />
        <div id="groupDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 2px solid var(--border-color); border-radius: var(--radius); margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: var(--shadow-lg);">
          <div id="groupList" style="padding: 0.5rem;"></div>
        </div>
      </div>
      <input type="hidden" id="groupSelect" value="" />
      <div id="selectedGroup" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--background); border-radius: var(--radius); display: none;">
        <span style="font-weight: 600;">選択中: </span>
        <span id="selectedGroupName"></span>
        <button type="button" id="clearGroupBtn" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; background: var(--secondary-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.875rem;">クリア</button>
      </div>
      <p class="text-muted" style="margin-top: 0.5rem;">まず、申請者を選択してください。</p>
    </section>

    <section>
      <h2><span class="step-number">3</span><span id="memberSectionTitle">追加するメンバーを選択</span></h2>
      <div style="margin-bottom: 1rem;">
        <input 
          type="text" 
          id="memberSearchInput" 
          placeholder="メンバー名、ユーザーID、メールアドレスで検索..."
          autocomplete="off"
          disabled
          style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius); font-size: 1rem; opacity: 0.5;"
        />
      </div>
      <div id="memberList" style="max-height: 400px; overflow-y: auto; padding: 1rem; background: var(--background); border-radius: var(--radius); border: 1px solid var(--border-color);">
        <p class="text-muted">まず、対象グループを選択してください。</p>
      </div>
    </section>

    <section>
      <h2><span class="step-number">4</span>申請理由を記入 <span style="color: #dc3545;">*</span></h2>
      <textarea 
        id="requestReason" 
        rows="4" 
        placeholder="申請理由を記入してください（必須）"
        required
        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius); font-size: 1rem; font-family: inherit; resize: vertical;"
      ></textarea>
    </section>

    <section>
      <div class="button-group">
        <button id="submitBtn" class="button-secondary">申請（履歴を保存）</button>
      </div>
    </section>
  </div>

  <script>
    const API_BASE = '/api';
    let allUsers = [];
    let filteredUsers = [];
    let allGroups = [];
    let filteredGroups = [];
    let allMembers = []; // 表示対象のメンバーリスト
    let filteredMembers = []; // フィルタリング後のメンバーリスト
    let currentGroupId = null; // 現在選択されているグループID
    let requestMode = 'add'; // 'add' or 'remove'

    // モード切り替えの処理
    function updateModeDisplay() {
      const mode = document.querySelector('input[name="requestMode"]:checked').value;
      requestMode = mode;
      
      const modeDescription = document.getElementById('modeDescription');
      const memberSectionTitle = document.getElementById('memberSectionTitle');
      
      if (mode === 'remove') {
        modeDescription.textContent = 'グループからメンバーを削除する申請を行います。';
        memberSectionTitle.textContent = '削除するメンバーを選択';
      } else {
        modeDescription.textContent = 'グループにメンバーを追加する申請を行います。';
        memberSectionTitle.textContent = '追加するメンバーを選択';
      }
      
      // グループが選択されている場合はメンバーリストを再読み込み
      const groupId = currentGroupId || document.getElementById('groupSelect').value;
      if (groupId) {
        loadMembersForGroup(groupId);
      }
    }

    // ログインチェック
    function checkAuth() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (!user) {
        alert('ログインが必要です');
        window.location.href = '/pages/login.html';
        return false;
      }
      return true;
    }

    // ログインユーザーをデフォルトで選択
    function selectLoggedInUser() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (user && user.id) {
        const loggedInUser = allUsers.find(u => u.id === user.id);
        if (loggedInUser) {
          selectUser(loggedInUser.id, loggedInUser.user_name);
        }
      }
    }

    async function loadUsers() {
      try {
        const res = await fetch(`${API_BASE}/users`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        allUsers = await res.json();
        filteredUsers = allUsers;
        renderUserList();
        
        // ログインユーザーをデフォルトで選択
        selectLoggedInUser();
      } catch (error) {
        console.error('Error loading users:', error);
        alert('ユーザーの読み込みに失敗しました。');
      }
    }

    async function loadGroups() {
      // グループ一覧は申請者選択時に動的に読み込むため、ここでは何もしない
    }
    
    async function loadUserGroups(userId) {
      try {
        const res = await fetch(`${API_BASE}/users/${userId}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const user = await res.json();
        allGroups = user.groups || [];
        filteredGroups = allGroups;
        renderGroupList();
      } catch (error) {
        console.error('Error loading user groups:', error);
        allGroups = [];
        filteredGroups = [];
        renderGroupList();
      }
    }

    function filterUsers() {
      const searchTerm = document.getElementById('userSearchInput').value.toLowerCase().trim();
      
      if (searchTerm === '') {
        filteredUsers = allUsers;
      } else {
        filteredUsers = allUsers.filter(user => {
          const nameMatch = user.user_name?.toLowerCase().includes(searchTerm);
          const idMatch = user.user_id?.toLowerCase().includes(searchTerm);
          const emailMatch = user.email?.toLowerCase().includes(searchTerm);
          const qsUsernameMatch = user.qs_username?.toLowerCase().includes(searchTerm);
          return nameMatch || idMatch || emailMatch || qsUsernameMatch;
        });
      }
      
      renderUserList();
    }

    function filterGroups() {
      const searchTerm = document.getElementById('groupSearchInput').value.toLowerCase().trim();
      
      if (searchTerm === '') {
        filteredGroups = allGroups;
      } else {
        filteredGroups = allGroups.filter(group => {
          return group.group_name?.toLowerCase().includes(searchTerm);
        });
      }
      
      renderGroupList();
    }

    function renderUserList() {
      const list = document.getElementById('userList');
      list.innerHTML = '';

      if (filteredUsers.length === 0) {
        list.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">該当するユーザーが見つかりませんでした。</div>';
        return;
      }

      filteredUsers.forEach(u => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid var(--border-color);';
        item.innerHTML = `
          <div style="font-weight: 600;">${escapeHtml(u.user_name || '名称不明')}</div>
          <div style="font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(u.user_id || 'ID不明')}</div>
        `;
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = 'var(--background)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = 'transparent';
        });
        item.addEventListener('click', () => {
          selectUser(u.id, u.user_name);
        });
        list.appendChild(item);
      });
    }

    function renderGroupList() {
      const list = document.getElementById('groupList');
      list.innerHTML = '';

      if (filteredGroups.length === 0) {
        list.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">該当するグループが見つかりませんでした。</div>';
        return;
      }

      filteredGroups.forEach(g => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid var(--border-color);';
        item.textContent = g.group_name;
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = 'var(--background)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = 'transparent';
        });
        item.addEventListener('click', () => {
          selectGroup(g.id, g.group_name);
        });
        list.appendChild(item);
      });
    }

    async function selectUser(userId, userName) {
      document.getElementById('userSelect').value = userId;
      document.getElementById('selectedUserName').textContent = userName;
      document.getElementById('selectedUser').style.display = 'block';
      document.getElementById('userSearchInput').value = '';
      document.getElementById('userDropdown').style.display = 'none';
      
      // グループ選択を有効化
      const groupSearchInput = document.getElementById('groupSearchInput');
      groupSearchInput.disabled = false;
      groupSearchInput.style.opacity = '1';
      
      // 申請者が所属するグループを取得
      await loadUserGroups(userId);
      
      // 所属グループが1つだけの場合は自動選択
      if (allGroups.length === 1) {
        const group = allGroups[0];
        selectGroup(group.id, group.group_name);
      } else if (allGroups.length > 1) {
        // 複数の場合は最初のグループを自動選択
        const group = allGroups[0];
        selectGroup(group.id, group.group_name);
      } else {
        // 所属グループがない場合
        groupSearchInput.placeholder = '所属グループがありません';
        document.getElementById('memberList').innerHTML = '<p class="text-muted">申請者が所属するグループがありません。</p>';
      }
    }

    function selectGroup(groupId, groupName) {
      document.getElementById('groupSelect').value = groupId;
      document.getElementById('selectedGroupName').textContent = groupName;
      document.getElementById('selectedGroup').style.display = 'block';
      document.getElementById('groupSearchInput').value = '';
      document.getElementById('groupDropdown').style.display = 'none';
      
      // メンバー一覧を読み込む
      loadMembersForGroup(groupId);
    }

    function clearUserSelection() {
      document.getElementById('userSelect').value = '';
      document.getElementById('selectedUser').style.display = 'none';
      document.getElementById('userSearchInput').value = '';
      const groupSearchInput = document.getElementById('groupSearchInput');
      groupSearchInput.disabled = true;
      groupSearchInput.style.opacity = '0.5';
      groupSearchInput.placeholder = 'グループ名で検索...';
      allGroups = [];
      filteredGroups = [];
      clearGroupSelection();
    }

    function clearGroupSelection() {
      document.getElementById('groupSelect').value = '';
      document.getElementById('selectedGroup').style.display = 'none';
      document.getElementById('groupSearchInput').value = '';
      document.getElementById('memberList').innerHTML = '<p class="text-muted">まず、対象グループを選択してください。</p>';
      document.getElementById('memberSearchInput').value = '';
      document.getElementById('memberSearchInput').disabled = true;
      document.getElementById('memberSearchInput').style.opacity = '0.5';
      allMembers = [];
      filteredMembers = [];
      currentGroupId = null;
    }

    async function loadMembersForGroup(groupId) {
      try {
        currentGroupId = groupId;
        const res = await fetch(`${API_BASE}/groups/${groupId}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const group = await res.json();
        
        // 既存メンバーのユーザーIDを取得
        const existingMemberUserIds = new Set();
        if (group.users && group.users.length > 0) {
          group.users.forEach(user => {
            existingMemberUserIds.add(user.id);
          });
        }
        
        // モードに応じてメンバーリストを準備
        if (requestMode === 'remove') {
          // 削除モード: 既存メンバーのみを表示
          allMembers = allUsers
            .filter(user => existingMemberUserIds.has(user.id))
            .map(user => ({
              ...user,
              isExisting: true
            }));
        } else {
          // 追加モード: すべてのユーザーを表示（既存メンバーは無効化）
          allMembers = allUsers.map(user => ({
            ...user,
            isExisting: existingMemberUserIds.has(user.id)
          }));
        }
        filteredMembers = allMembers;
        
        // 検索入力欄を有効化
        const memberSearchInput = document.getElementById('memberSearchInput');
        memberSearchInput.disabled = false;
        memberSearchInput.style.opacity = '1';
        
        // メンバーリストを表示
        renderMemberList();
      } catch (error) {
        console.error('Error loading members:', error);
        document.getElementById('memberList').innerHTML = '<p class="text-muted">メンバー情報の読み込みに失敗しました。</p>';
      }
    }

    function filterMembers() {
      const searchTerm = document.getElementById('memberSearchInput').value.trim().toLowerCase();
      
      if (!searchTerm) {
        filteredMembers = allMembers;
      } else {
        filteredMembers = allMembers.filter(member => {
          const nameMatch = (member.user_name || '').toLowerCase().includes(searchTerm);
          const idMatch = (member.user_id || '').toLowerCase().includes(searchTerm);
          const emailMatch = (member.email || '').toLowerCase().includes(searchTerm);
          const qsUsernameMatch = (member.qs_username || '').toLowerCase().includes(searchTerm);
          return nameMatch || idMatch || emailMatch || qsUsernameMatch;
        });
      }
      
      renderMemberList();
    }

    function renderMemberList() {
      const container = document.getElementById('memberList');
      container.innerHTML = '';
      
      if (filteredMembers.length === 0) {
        container.innerHTML = '<p class="text-muted">該当するメンバーが見つかりませんでした。</p>';
        return;
      }
      
      filteredMembers.forEach(member => {
        const isExisting = member.isExisting;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.marginBottom = '0.75rem';
        label.style.padding = '0.5rem';
        label.style.borderRadius = 'var(--radius)';
        
        if (requestMode === 'remove') {
          // 削除モード: 既存メンバーは選択可能
          label.style.cursor = 'pointer';
          label.style.opacity = '1';
          label.addEventListener('mouseenter', () => {
            label.style.backgroundColor = 'var(--background)';
          });
          label.addEventListener('mouseleave', () => {
            label.style.backgroundColor = 'transparent';
          });
        } else {
          // 追加モード: 既存メンバーは無効化
          label.style.cursor = isExisting ? 'not-allowed' : 'pointer';
          label.style.opacity = isExisting ? '0.5' : '1';
          if (!isExisting) {
            label.addEventListener('mouseenter', () => {
              label.style.backgroundColor = 'var(--background)';
            });
            label.addEventListener('mouseleave', () => {
              label.style.backgroundColor = 'transparent';
            });
          }
        }
        
        label.innerHTML = `
          <input type="checkbox"
                 value="${member.id}"
                 ${requestMode === 'add' && isExisting ? 'disabled checked' : ''}
                 style="margin-right: 0.5rem;">
          <span style="flex: 1;">
            <strong>${escapeHtml(member.user_name || '名称不明')}</strong>
            <code style="margin-left: 0.5rem; font-size: 0.875rem;">${escapeHtml(member.user_id || 'ID不明')}</code>
            ${member.email ? `<span style="margin-left: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(member.email)}</span>` : ''}
            ${requestMode === 'add' && isExisting ? '<span style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #d4edda; color: #155724; border-radius: var(--radius); font-size: 0.875rem;">既存メンバー</span>' : ''}
            ${requestMode === 'remove' && isExisting ? '<span style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #fff3cd; color: #856404; border-radius: var(--radius); font-size: 0.875rem;">既存メンバー</span>' : ''}
          </span>
        `;
        container.appendChild(label);
      });
    }

    async function submitRequest() {
      const userId = document.getElementById('userSelect').value;
      const groupId = document.getElementById('groupSelect').value;
      const requestReason = document.getElementById('requestReason').value.trim();
      
      if (!userId) {
        alert('申請者を選択してください');
        return;
      }
      if (!groupId) {
        alert('対象グループを選択してください');
        return;
      }
      
      const checked = document.querySelectorAll('#memberList input[type=checkbox]:checked:not(:disabled)');
      const memberUserIds = Array.from(checked).map(c => Number(c.value));

      if (memberUserIds.length === 0) {
        const message = requestMode === 'remove' 
          ? '削除するメンバーを1人以上選択してください'
          : '追加するメンバーを1人以上選択してください';
        alert(message);
        return;
      }
      if (!requestReason) {
        alert('申請理由を入力してください');
        document.getElementById('requestReason').focus();
        return;
      }

      const confirmMessage = requestMode === 'remove' 
        ? 'メンバー削除申請を送信しますか？'
        : 'メンバー追加申請を送信しますか？';
      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const requestType = requestMode === 'remove' ? 'remove_members' : 'add_members';
        const res = await fetch(`${API_BASE}/requests/add-members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: Number(userId),
            groupId: Number(groupId),
            memberUserIds: memberUserIds,
            requestReason: requestReason,
            requestType: requestType
          })
        });
        
        const data = await res.json();
        if (data.error) {
          alert(data.error);
          return;
        }
        
        const successMessage = requestMode === 'remove' 
          ? 'メンバー削除申請を保存しました'
          : 'メンバー追加申請を保存しました';
        alert(successMessage);
        
        // フォームをリセット
        clearUserSelection();
        clearGroupSelection();
        document.getElementById('requestReason').value = '';
      } catch (error) {
        console.error('Error submitting request:', error);
        alert('申請の保存に失敗しました');
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // イベントリスナー
    document.getElementById('userSearchInput').addEventListener('input', () => {
      filterUsers();
      document.getElementById('userDropdown').style.display = 'block';
    });

    document.getElementById('userSearchInput').addEventListener('focus', () => {
      if (filteredUsers.length > 0) {
        document.getElementById('userDropdown').style.display = 'block';
      }
    });

    document.getElementById('groupSearchInput').addEventListener('input', () => {
      filterGroups();
      document.getElementById('groupDropdown').style.display = 'block';
    });

    document.getElementById('groupSearchInput').addEventListener('focus', () => {
      if (filteredGroups.length > 0) {
        document.getElementById('groupDropdown').style.display = 'block';
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('#userSearchInput') && !e.target.closest('#userDropdown')) {
        document.getElementById('userDropdown').style.display = 'none';
      }
      if (!e.target.closest('#groupSearchInput') && !e.target.closest('#groupDropdown')) {
        document.getElementById('groupDropdown').style.display = 'none';
      }
    });

    document.getElementById('clearUserBtn').addEventListener('click', clearUserSelection);
    document.getElementById('clearGroupBtn').addEventListener('click', clearGroupSelection);
    document.getElementById('submitBtn').addEventListener('click', submitRequest);

    // モード切り替えのイベントリスナー
    document.querySelectorAll('input[name="requestMode"]').forEach(radio => {
      radio.addEventListener('change', updateModeDisplay);
    });
    
    // 初期表示を更新
    updateModeDisplay();

    // メンバー検索入力欄のイベントリスナー
    const memberSearchInput = document.getElementById('memberSearchInput');
    memberSearchInput.addEventListener('input', () => {
      filterMembers();
    });

    // 初期読み込み
    if (checkAuth()) {
      loadUsers();
    }
  </script>
</body>
</html>

