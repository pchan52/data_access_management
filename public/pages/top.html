<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quicksight ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <div class="container">
  <h1>Quicksight ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</h1>
  
  <div id="userInfo" style="text-align: right; margin-bottom: 1rem; padding: 0.75rem; background: var(--surface); border-radius: var(--radius);">
    <span id="userName" style="margin-right: 1rem;"></span>
    <button id="logoutBtn" onclick="handleLogout()" style="padding: 0.5rem 1rem; background: var(--secondary-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.875rem;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <section>
    <h2>ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦</h2>
    <p>
      Quicksight ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç”³è«‹ãƒ»ç®¡ç†ã‚’è¡Œã†ãŸã‚ã®ãƒãƒ¼ã‚¿ãƒ«ã§ã™ã€‚<br>
      ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ç”³è«‹ã€æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆç”³è«‹ã€ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ç”³è«‹ã‚’ä¸€å…ƒç®¡ç†ã—ã€æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã‚’åŠ¹ç‡åŒ–ã—ã¾ã™ã€‚
    </p>
    <p style="margin-top: 1rem;">
      <a href="/pages/usage.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">
        ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹ â†’
      </a>
    </p>
  </section>

  <section id="userGroupsSection" style="display: none;">
    <h2>æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—</h2>
    <div id="userGroupsList">
      <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </section>

  <section>
    <h2>ãƒšãƒ¼ã‚¸ä¸€è¦§</h2>
    
    <div class="page-section">
      <h3>ç”³è«‹ãƒšãƒ¼ã‚¸</h3>
      <ul class="page-list">
        <li><a href="/pages/request.html">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ç”³è«‹<br><span class="text-muted">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ç”³è«‹</span></a></li>
        <li><a href="/pages/member_request.html">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ç”³è«‹<br><span class="text-muted">æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ãƒ»å‰Šé™¤ç”³è«‹</span></a></li>
        <li><a href="/pages/group_request.html">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ç”³è«‹<br><span class="text-muted">æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆãƒ»å‰Šé™¤ç”³è«‹</span></a></li>
      </ul>
    </div>

    <div class="page-section">
      <h3>ç”³è«‹ä¸€è¦§</h3>
      <ul class="page-list">
        <li><a href="/pages/drafts.html">ãƒ‰ãƒ©ãƒ•ãƒˆä¸€è¦§<br><span class="text-muted">ä¿å­˜ã—ãŸãƒ‰ãƒ©ãƒ•ãƒˆã®é–²è¦§ãƒ»ç·¨é›†</span></a></li>
        <li><a href="/pages/requests.html">ç”³è«‹ä¸€è¦§<br><span class="text-muted">ç™»éŒ²ã•ã‚ŒãŸç”³è«‹ã®ä¸€è¦§ã¨è©³ç´°ç¢ºèª</span></a></li>
        <li id="approvalLink" style="display: none;"><a href="/pages/approval.html">æ‰¿èªç”»é¢<br><span class="text-muted">æ‰¿èªå¾…ã¡ç”³è«‹ã®æ‰¿èªãƒ»å´ä¸‹</span></a></li>
      </ul>
    </div>

    <div class="page-section">
      <h3>ä¸€è¦§ãƒšãƒ¼ã‚¸</h3>
      <ul class="page-list">
        <li><a href="/pages/datasets.html">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§<br><span class="text-muted">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿é–²è¦§</span></a></li>
        <li><a href="/pages/groups.html">QSã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§<br><span class="text-muted">ã‚ªãƒ¼ãƒŠãƒ¼ã€ãƒ¡ãƒ³ãƒãƒ¼ã€å¯¾å¿œDBPã€ç”³è«‹å±¥æ­´</span></a></li>
        <li><a href="/pages/users.html">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§<br><span class="text-muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—</span></a></li>
        <li><a href="/pages/applications.html">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§<br><span class="text-muted">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ“ã‚¸ãƒã‚¹ã‚ªãƒ¼ãƒŠãƒ¼</span></a></li>
      </ul>
    </div>
  </section>
  </div>

  <script>
    const API_BASE = window.location.origin + '/api';

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    function checkAuth() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (!user) {
        window.location.href = '/pages/login.html';
        return false;
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
      const userName = document.getElementById('userName');
      userName.textContent = `${user.user_name || user.email} ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;
      
      // æ‰¿èªè€…ã®å ´åˆã®ã¿æ‰¿èªç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
      const isApprover = localStorage.getItem('isApprover') === 'true';
      const approvalLink = document.getElementById('approvalLink');
      if (isApprover) {
        approvalLink.style.display = 'block';
      } else {
        approvalLink.style.display = 'none';
      }
      
      // æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—ã‚’èª­ã¿è¾¼ã‚€
      if (user.id) {
        loadUserGroups(user.id);
      }
      
      return true;
    }

    async function loadUserGroups(userId) {
      try {
        const res = await fetch(`${API_BASE}/users/${userId}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const user = await res.json();
        
        const groupsSection = document.getElementById('userGroupsSection');
        const groupsList = document.getElementById('userGroupsList');
        
        if (user.groups && user.groups.length > 0) {
          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
          user.groups.forEach(group => {
            const ownerDisplay = group.group_owner_name 
              ? `${escapeHtml(group.group_owner_name)} (${escapeHtml(group.group_owner || '')})`
              : escapeHtml(group.group_owner || '(æœªè¨­å®š)');
            const dbpDisplay = group.dbp_manager_name
              ? `${escapeHtml(group.dbp_manager_name)} (${escapeHtml(group.dbp_manager || '')})`
              : escapeHtml(group.dbp_manager || '(æœªè¨­å®š)');
            
            html += `
              <div style="padding: 1rem; background: var(--background); border: 2px solid var(--border-color); border-radius: var(--radius);">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">${escapeHtml(group.group_name || '')}</h3>
                <p style="margin: 0.25rem 0; font-size: 0.875rem;">
                  <strong>ã‚°ãƒ«ãƒ¼ãƒ—ã‚ªãƒ¼ãƒŠãƒ¼:</strong> ${ownerDisplay}
                </p>
                <p style="margin: 0.25rem 0; font-size: 0.875rem;">
                  <strong>DBPãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼:</strong> ${dbpDisplay}
                </p>
              </div>
            `;
          });
          html += '</div>';
          groupsList.innerHTML = html;
          groupsSection.style.display = 'block';
        } else {
          groupsList.innerHTML = '<p style="color: var(--text-secondary);">æ‰€å±ã—ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          groupsSection.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading user groups:', error);
        document.getElementById('userGroupsList').innerHTML = 
          '<p style="color: var(--warning-color);">ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        document.getElementById('userGroupsSection').style.display = 'block';
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function handleLogout() {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem('user');
        localStorage.removeItem('isApprover');
        window.location.href = '/pages/login.html';
      }
    }

    // åˆæœŸèª­ã¿è¾¼ã¿
    checkAuth();
  </script>
</body>
</html>
